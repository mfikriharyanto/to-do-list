image: golang:latest

stages:
  - build
  - test
  - analyze

before_script:
  - go version
  - go mod download
  - chmod +x ./setup_env.sh
  - ./setup_env.sh

build:
  stage: build
  script:
    - go build -o todolist

test:
  stage: test
  script:
    - go test -v ./...

analyze:
  stage: analyze
  image: golang:latest
  before_script:
    - apt-get update
    - apt-get install -y unzip
    - curl -sSLo /tmp/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
    - unzip /tmp/sonar-scanner.zip -d /opt
    - ln -s /opt/sonar-scanner-4.8.0.2856-linux/bin/sonar-scanner /usr/local/bin/sonar-scanner
    - go version
  script:
    - sonar-scanner \
        -Dsonar.host.url=$SONAR_HOST_URL \
        -Dsonar.login=$SONAR_TOKEN \
        -Dsonar.projectKey=$SONAR_PROJECT_KEY \
        -Dsonar.language=go \
        -Dsonar.sources=. \
        -Dsonar.exclusions=**/*_test.go \
        -Dsonar.tests=. \
        -Dsonar.test.inclusions=**/*_test.go \